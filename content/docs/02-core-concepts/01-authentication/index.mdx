---
title: "Authentication"
description: "Learn everything about how authentication works in Fungi."
---

By default, anyone can become a [client](/docs/01-getting-started/01-overview#clients) of your Fungi instance. This is by design because you don't always need auth in your app. This is not a security flaw because clients can only access private data with your server's authorization.

## Authenticating subscriptions

Fungi's APIs will only allow clients to subscribe to a [private channel](/docs/01-getting-started/01-overview#private-channels) if the subscription request includes an auth token signed by your server. This gives you full control over auth because everything happens on your server, for example if user Alice is the only user that can subscribe to a private channel, then your server should only give an auth token to Alice. Our client SDKs will do the heavy lifting for you by requesting an auth token from your server when the client subscribes to a private channel so that the subscription can be authorized.

### Authentication steps

1. Client attempts to connect: `let client = new Client({ endpoint })`
2. Connection established with Fungi (`fungi:connection_established`) which sends back a unique socket id for that client.
3. Client attempts to subscribe to private channel: `client.subscribe('private-channel')`.
4. Client SDK asks your server for an auth token, for example by hitting https://your-app.com/fungi/auth which could be an endpoint that your server responds to with an auth token.
5. Your server sends the client the following **JSON**:

```json
{ "auth": "key:signature" }
```

You can learn more about the auth token [here](#the-auth-token).

6. Client SDK sends subscription requests for the channel specified in step 3 along with the auth token. If the auth token is valid then a `fungi:subscription_succeeded` system event will be triggered, on the other hand, if isn't a valid auth token then a `fungi:subscription_error` event will be triggered. You can read more about system events [here](/docs/01-getting-started/01-overview#system-events).

## Server-side endpoint implementation

You can start with an authentication endpoint that authorizes every request it receives. You can do that with the help of one of the examples below.

### Node

Install the dependencies:

```
npm install @fungi-realtime/node express cors
```

```js
const cors = require("cors");
const express = require("express");
const { Client } = require("@fungi-realtime/node");

let app = express();

let client = new Client({
  key: "app-test-key",
  secret: "app-test-secret",
});

app.use(express.json());
app.use(cors());

app.post("/fungi/auth", (req, res) => {
  let socketId = req.body.socket_id;
  let channel = req.body.channel_name;
  let auth = client.authenticate(socketId, channel);
  res.json(auth);
});

let port = process.env.PORT || 5000;
app.listen(port);
```

## Server-side notes

You should have the following in mind to implement the auth endpoint on your server:

- Any non-2xx HTTP status code received from your endpoint will be considered an unsuccessful response.

- Your endpoint should carry a 2xx HTTP status code and a JSON response with the following body if the auth was successful:

```json
{ "auth": "key:signature" }
```

## Configuring the client SDK

You must tell the client SDK where the authentication request should be sent to (there's no default value).

```js
new Client({
  endpoint: "ws://localhost:8081",

  // In this example, there's a server running on port 3000
  // which authenticates subscriptions on the /fungi/auth endpoint.
  auth: {
    endpoint: "http://localhost:3000/fungi/auth",
  },
});
```

### Adding headers to the authentication request

If your server's authentication endpoint requires additional headers to perform the authentication for example for CSRF protection, you can specify them when creating the client.

```diff-js
  new Client({
    endpoint: "ws://localhost:8081",

    // In this example, there's a server running on port 3000
    // which authenticates subscriptions on the /fungi/auth endpoint.
    auth: {
      endpoint: "http://localhost:3000/fungi/auth",
+     headers: {
+       'X-CSRF-Token': 'some_token'
+     }
    }
  });
```

## The auth token

The auth token is a string generated by your server which **authorizes a subscription for a specific channel and client**.

It should look like

```json
<app-key>:<signature>
```

The signature is a HMAC SHA256 hex digest which is generated by signing the following string with your secret

```json
<socket-id>:<channel-name>
```

### Generating an auth token example

All our server SDKs generate this for you with the `authenticate` method but we'll explain how you could generate one if for example we don't have an SDK for your language.

Let's imagine that these are our credentials

```json
key = "dNWdCrBj2QeMrB5etEFyxRhMyP9QGxCQPP"
secret = "kDUmhJ4BPzLskuy3R6ayJLQJFqY38HcBZh"
```

And the client connected has a socket id of `123`. Every client receives an unique socket id upon establishing a connection to Fungi like explained [here](#authentication-steps).

Given that your application receives a POST request to /fungi/auth sent from the SDK when trying to authenticate a subscription with the body

```json
{
  "socket_id": "123",
  "channel_name": "private-foobar"
}
```

You would first check that the user (authenticated via cookies or whatever) has the necessary permissions to subscribe to the `private-foobar` channel, if they do you would create a HMAC SHA256 hex digest of the following string using your credential's secret

```json
123:private-foobar
```

Using Node as an example

```js
const crypto = require("crypto");

let key = "dNWdCrBj2QeMrB5etEFyxRhMyP9QGxCQPP";
let secret = "kDUmhJ4BPzLskuy3R6ayJLQJFqY38HcBZh";
let stringToSign = `${socketId}:${channelName}`;

let signature = crypto
  .createHmac("sha256", secret)
  .update(stringToSign)
  .digest("hex");

let authToken = `${key}:${signature}`;
console.log(authToken);
// xxxxxxxxxxxxxx:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

The auth response from your server should be a JSON with an `auth` property with the generated auth token from the previous snippet:

```json
{
  "auth": "xxxxxxxxxxxxxx:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
}
```
